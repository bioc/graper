{
    "collab_server" : "",
    "contents" : "---\ntitle: \"Get views\"\nauthor: \"Britta Velten\"\ndate: \"3/23/2017\"\noutput:\n  BiocStyle::html_document:\n    toc: true\n---\n\n```{r, message=F, warning=FALSE}\nlibrary(dplyr)\nlibrary(DESeq2)\nlibrary(data.table)\n```\n\n\n# Set general in/out parameters\n```{r}\n#input files\nRNAseqFile<-\"~/Documents/MOFA/CLL_MOFA_data/pace/data/dds.RData\"\nmethFile<-\"~/Documents/MOFA/CLL_MOFA_data/pace/data/meth.RData\"\nDrugResponseFile<-\"~/Documents/MOFA/CLL_MOFA_data/pace/data/lpdAll.RData\"\nPatMetaFile<-\"~/Documents/MOFA/CLL_MOFA_data/pace/data/patmeta.RData\"\nMutationsFile<-\"~/Documents/MOFA/CLL_MOFA_data/pace/data/mutCOM.RData\"\n  \n#output files\n# outDir<-\"~/Documents/MOFA/CLL_MOFA_data/views/all\"\n# outDir<-\"~/Documents/MOFA/CLL_MOFA_data/views/all_small_noXY\"\n# outDir<-\"~/Documents/MOFA/CLL_MOFA_data/views/all_small_noXY_alldrugs\"\noutDir<-\"~/Documents/MOFA/CLL_MOFA_data/views/all_small_noXY_alldrugs_MCLL\"\n# outDir<-\"~/Documents/MOFA/CLL_MOFA_data/views/all_small_noXY_plushMNC\"\n\n# outDir<-\"~/Documents/MOFA/CLL_MOFA_data/views/all_wPellet\"\n\n# outDirOverlap<-\"~/Documents/MOFA/CLL_MOFA_data/views/commonPats\"\n# outDirOverlap<-\"~/Documents/MOFA/CLL_MOFA_data/views/commonPats_small_noXY\"\n# outDirOverlap<-\"~/Documents/MOFA/CLL_MOFA_data/views/commonPats_small_noXY_alldrugs\"\noutDirOverlap<-\"~/Documents/MOFA/CLL_MOFA_data/views/commonPats_small_noXY_alldrugs_MCLL\"\n# outDirOverlap<-\"~/Documents/MOFA/CLL_MOFA_data/views/commonPats_small_noXY_plushMNC\"\n# outDirOverlap<-\"~/Documents/MOFA/CLL_MOFA_data/views/commonPats_wPellet\"\n\nif(!dir.exists(outDir))  dir.create(outDir)\nif(!dir.exists(outDirOverlap))  dir.create(outDirOverlap)\n\n\n#patients to be included (only CLL)\nnamePatMeta<-load(PatMetaFile)\npatmeta<-get(namePatMeta)\npatmeta$PatID<-rownames(patmeta)\npatCLL<-patmeta %>% filter(Diagnosis==\"CLL\")\n#patients to be included (only M-CLL)\npatCLL<-patmeta %>% filter(IGHV==\"M\")\n\n#include healthy controls\n# patCLL<-patmeta %>% filter(Diagnosis==\"CLL\" | Diagnosis==\"hMNC\")\nrownames(patCLL)<-patCLL$PatID\n```\n\n#Get RNAseq\n```{r}\nsource(\"~/Documents/MOFA/CLL_MOFA_data/views/getRNAseq.R\")\n  \n#annotation file from ENSEMBLE (corresponding to GRCh 37.1)\nAnnoFileList<-list(\n  mRNA= \"~/Documents/BioMart/Hsapiens_genes_BioMart.75.txt\",\n  lincRNA = \"~/Documents/BioMart/Hsapiens_lincRNA_BioMart.75.txt\",\n  miRNA = \"~/Documents/BioMart/Hsapiens_miRNA_BioMart.75.txt\"\n)\n\n#For with pellet:\n# RNA<- getRNAseq(file =RNAseqFile, pat2include = patCLL$PatID,\n#                 minrs = 100, AnnoFileList = AnnoFileList, plotit = T,\n#                 outdir = outDir, onlyCD19 = F, topmRNA=10000, noY=T)\n#For small:\nRNA<- getRNAseq(file =RNAseqFile, pat2include = patCLL$PatID,\n                minrs = 100, AnnoFileList = AnnoFileList, plotit = T,\n                outdir = outDir, onlyCD19 = F, topmRNA=5000, noY=T)\n\n# For without pellets:\n# RNA<- getRNAseq(file =RNAseqFile, pat2include = patCLL$PatID,\n#                 minrs = 100, AnnoFileList = AnnoFileList, plotit = T,\n#                 outdir = outDir, onlyCD19 = T, topmRNA=10000, noY=T)\n\nany(is.na(Reduce(cbind,RNA)))\n```\n\n#Get methylation data\n```{r}\nsource(\"~/Documents/MOFA/CLL_MOFA_data/views/getMeth.R\")\n# meth<-getMeth(methFile, pat2include = patCLL$PatID,\n#               Frac2include = 0.1, outdir = outDir, includeXYchr=T,\n#               methDataFile=\"zcat < /Users/bvelten/Documents/MOFA/CLL_MOFA_data/methylation/in/met.tsv.gz\")\n#for small\nmeth<-getMeth(methFile, pat2include = patCLL$PatID,\n              Frac2include = 0.01, outdir = outDir, includeXYchr=F,\n              methDataFile=\"zcat < /Users/bvelten/Documents/MOFA/CLL_MOFA_data/methylation/in/met.tsv.gz\")\nany(is.na(meth))\n```\n\n#Get drug response \n```{r}\nsource(\"~/Documents/MOFA/CLL_MOFA_data/views/getViab.R\")\n# Threshold parameters: drugs are accepted that for at least `effectNum` samples \n# have a viability effect less than or equal to `effectVal`. On the other hand, the \n# mean viability effect should not be below `viab`.\n\n# viab<-getViab(file = DrugResponseFile, \n#                   pat2include = patCLL$PatID,\n#                   badDrugs=c( \"D_008\",  \"D_025\"), \n#                   conc2include = 2:5,\n#                   targetedDrugs= c(\"D_002\", \"D_003\", \"D_166\", \"D_082\", \"D_079\", \"D_012\", \"D_030\", \"D_063\", \"D_083\") , \n#                   conc4targeted = c(4,5),\n#                   chemoDrugs = c(\"D_006\", \"D_159\", \"D_010\"),\n#                   conc4chemo = 3:5,\n#                   effectNum = 4,\n#                   effectVal = 0.7,\n#                   viab = 0.6, \n#                   maxval = 1.1,\n#                   outdir = outDir)\n\n#include all drugs and conc\nviab <- getViab(file = DrugResponseFile, \n                  pat2include = patCLL$PatID,\n                  badDrugs=c( \"D_008\",  \"D_025\"), \n                  conc2include = 1:5,\n                  targetedDrugs= c(\"D_002\", \"D_003\", \"D_166\", \"D_082\", \"D_079\", \"D_012\", \"D_030\", \"D_063\", \"D_083\") , \n                  conc4targeted = 1:5,\n                  chemoDrugs = c(\"D_006\", \"D_159\", \"D_010\"),\n                  conc4chemo = 1:5,\n                  effectNum = 1,\n                  effectVal = 1,\n                  viab = 0, \n                  maxval = 1.1,\n                  plotit =F,\n                  outdir = outDir)\nany(is.na(viab))\n```\n\n#Get mutations\n```{r}\nsource(\"~/Documents/MOFA/CLL_MOFA_data/views/getMut.R\")\nmut<-getMut(file = MutationsFile, \n                  pat2include = patCLL$PatID,\n                  minObs = 3,\n                  outdir = outDir)\n\n#add IGHV status to mutations\nighv<-patCLL[rownames(mut),\"IGHV\"]\nighv<-ifelse(ighv==\"U\",0,1)\nmut<-cbind(mut, IGHV=ighv)\n\nany(is.na(mut))\nany(apply(mut,1,function(r) all(is.na(r))))\n```\n\n# Get covariates\n```{r}\nsource(\"~/Documents/MOFA/CLL_MOFA_data/views/getCovariates.R\")\ncovariates <- getCovariates(file = PatMetaFile,\n              pat2include = patCLL$PatID,\n              cov2include = c(\"Gender\", \"Diagnosis\"),\n              outdir = outDir)\n```\n\n#Overview Sampler per Omic\n```{r}\nPatPerView<-lapply(list(RNA=RNA[[1]], meth=meth, viab=viab, mut=mut, covariates = covariates), rownames)\ngplots::venn(PatPerView)\n```\n\n\n#Save for union of all patients\n```{r}\nunionPats<-Reduce(union, PatPerView)\nsubset_augment<-function(mat, pats) {\n  aug_mat<-matrix(NA, ncol=ncol(mat), nrow=length(pats))\n  aug_mat<-mat[match(pats,rownames(mat)),,drop=FALSE]\n  rownames(aug_mat)<-pats\n  colnames(aug_mat)<-colnames(mat)\n  return(aug_mat)\n}\nviab_aug<-subset_augment(viab, pats=unionPats)\nmeth_aug<-subset_augment(meth, pats=unionPats)\nmut_aug<-subset_augment(mut, pats=unionPats)\nRNA_aug<-lapply(RNA, function(RNAsub) subset_augment(RNAsub, pats=unionPats))\ncovariates_aug <- subset_augment(covariates, pats=unionPats)\n\n```\n\n##Save views with all samples in any view\n```{r}\n  write.table(viab_aug[unionPats,], file=file.path(outDir,\"viab.txt\"),\n                row.names=TRUE, col.names=TRUE, quote=F)\n  write.table(meth_aug[unionPats,], file=file.path(outDir,\"meth.txt\"),\n                row.names=TRUE, col.names=TRUE, quote=F)\n  write.table(mut_aug[unionPats,], file=file.path(outDir,\"mut.txt\"),\n                row.names=TRUE, col.names=TRUE, quote=F)\n  write.table(covariates_aug[unionPats,], file=file.path(outDir,\"covariates.txt\"),\n                row.names=TRUE, col.names=TRUE, quote=F)\n  for(nm in names(RNA_aug)) write.table(RNA_aug[[nm]][unionPats,], \n                                        file=file.path(outDir,paste(nm,\".txt\", sep=\"\")), \n                                        row.names=TRUE, col.names=TRUE, quote=F)\n```\n\n\n#Overlap of  samples in views\n```{r}\ncommonPats<-Reduce(intersect, PatPerView)\n\n#Filter out mutations that occur less than minObs in the joint samples\nminObs<-3\nmut4common<-mut[,colSums(mut[commonPats,], na.rm = T)>=minObs]\n```\n\n##Save views with overlapping samples only\n```{r}\n  write.table(viab[commonPats,], file=file.path(outDirOverlap,\"viab.txt\"),\n                row.names=TRUE, col.names=TRUE, quote=F)\n  write.table(meth[commonPats,], file=file.path(outDirOverlap,\"meth.txt\"),\n                row.names=TRUE, col.names=TRUE, quote=F)\n  write.table(mut4common[commonPats,], file=file.path(outDirOverlap,\"mut.txt\"),\n                row.names=TRUE, col.names=TRUE, quote=F)\n  write.table(covariates[commonPats,], file=file.path(outDirOverlap,\"covariates.txt\"),\n                row.names=TRUE, col.names=TRUE, quote=F)\n  for(nm in names(RNA)) write.table(RNA[[nm]][commonPats,], file=file.path(outDirOverlap,paste(nm,\".txt\", sep=\"\")), \n                row.names=TRUE, col.names=TRUE, quote=F)\n```\n\n\n<!-- #Save views with 1% missing values -->\n<!-- The masking is now done internally in python. -->\n<!-- ```{r, eval=F} -->\n<!-- MaskAtRandom<-function(mat, seed, perc=1){ -->\n<!--   n<-nrow(mat) -->\n<!--   p<-ncol(mat) -->\n<!--   set.seed(seed) -->\n<!--   ridx<-sample(1:n, round(perc/100*n*p), replace = T) -->\n<!--   cidx<-sample(1:p, round(perc/100*n*p), replace = T) -->\n<!--   mat[cbind(ridx, cidx)]<-NA -->\n<!--   mat -->\n<!-- } -->\n<!-- for(perc in c(1, 10, 20)){  -->\n<!-- viab_missingAtRandom<-MaskAtRandom(viab[commonPats,], seed=21893, perc=perc) -->\n<!-- meth_missingAtRandom<-MaskAtRandom(meth[commonPats,], seed=23412, perc=perc) -->\n<!-- RNA_missingAtRandom<-lapply(RNA, function(sub) MaskAtRandom(sub[commonPats,], seed=13454, perc=perc)) -->\n\n<!-- # pheatmap(is.na(viab_missingAtRandom)*1, cluster_rows = F, cluster_cols = F) -->\n<!-- # pheatmap(is.na(meth_missingAtRandom)*1, cluster_rows = F, cluster_cols = F) -->\n<!-- # pheatmap(is.na(RNA_missingAtRandom[[1]])*1, cluster_rows = F, cluster_cols = F) -->\n<!-- # pheatmap(is.na(RNA_missingAtRandom[[2]])*1, cluster_rows = F, cluster_cols = F) -->\n<!-- # pheatmap(is.na(RNA_missingAtRandom[[3]])*1, cluster_rows = F, cluster_cols = F) -->\n\n<!-- write.table(viab_missingAtRandom, file=file.path(outDirOverlap,paste(\"viab_missingAtRandom_\",perc,\"p.txt\", sep=\"\")), -->\n<!--                 row.names=TRUE, col.names=TRUE, quote=F) -->\n<!-- write.table(meth_missingAtRandom, file=file.path(outDirOverlap,paste(\"meth_missingAtRandom_\",perc,\"p.txt\", sep=\"\")), -->\n<!--                 row.names=TRUE, col.names=TRUE, quote=F) -->\n<!-- for(nm in names(RNA_missingAtRandom)) write.table(RNA_missingAtRandom[[nm]], file=file.path(outDirOverlap,paste(nm,\"_missingAtRandom_\",perc,\"p.txt\", sep=\"\")), -->\n<!--                 row.names=TRUE, col.names=TRUE, quote=F) -->\n<!-- } -->\n<!-- ``` -->\n\n<!-- #Save views with 5 completely not observed patients in one view -->\n<!-- ```{r, eval=F} -->\n<!-- MaskCompleteView<-function(mat, seed, nPat=5){ -->\n<!--   n<-nrow(mat) -->\n<!--   set.seed(seed) -->\n<!--   ridx<-sample(1:n, nPat, replace = F) -->\n<!--   mat[ridx,]<-NA -->\n<!--   mat -->\n<!-- } -->\n<!-- viab_missing5Pat<-MaskCompleteView(viab[commonPats,], seed=63462, nPat=5) -->\n<!-- meth_missing5Pat<-MaskCompleteView(meth[commonPats,], seed=654574, nPat=5) -->\n<!-- RNA_missing5Pat<-lapply(RNA, function(sub) MaskCompleteView(sub[commonPats,], seed=54334, nPat=5)) -->\n\n<!-- # pheatmap(is.na(viab_missing5Pat)*1, cluster_rows = F, cluster_cols = F) -->\n<!-- # pheatmap(is.na(meth_missing5Pat)*1, cluster_rows = F, cluster_cols = F) -->\n<!-- # pheatmap(is.na(RNA_missing5Pat[[1]])*1, cluster_rows = F, cluster_cols = F) -->\n<!-- # pheatmap(is.na(RNA_missing5Pat[[2]])*1, cluster_rows = F, cluster_cols = F) -->\n<!-- # pheatmap(is.na(RNA_missing5Pat[[3]])*1, cluster_rows = F, cluster_cols = F) -->\n\n<!-- write.table(viab_missingAtRandom, file=file.path(outDirOverlap,\"viab_missing5Pat.txt\"), -->\n<!--                 row.names=TRUE, col.names=TRUE, quote=F) -->\n<!-- write.table(meth_missingAtRandom, file=file.path(outDirOverlap,\"meth_missing5Pat.txt\"), -->\n<!--                 row.names=TRUE, col.names=TRUE, quote=F) -->\n<!-- for(nm in names(RNA_missingAtRandom)) write.table(RNA_missingAtRandom[[nm]], file=file.path(outDirOverlap,paste(nm,\"missing5Pat.txt\", sep=\"\")), -->\n<!--                 row.names=TRUE, col.names=TRUE, quote=F) -->\n<!-- ``` -->\n",
    "created" : 1495086363455.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "3215819308",
    "id" : "6566CEBC",
    "lastKnownWriteTime" : 1495086504,
    "last_content_update" : 1495086504422,
    "path" : "~/Documents/MOFA/CLL_MOFA_data/views/GetViews.Rmd",
    "project_path" : null,
    "properties" : {
    },
    "relative_order" : 7,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_markdown"
}